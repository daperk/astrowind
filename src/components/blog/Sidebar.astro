---
import { Icon } from 'astro-icon/components';
import type { Post } from '~/types';
import { getPermalink } from '~/utils/permalinks';
import { findImage } from '~/utils/images';
import Image from '~/components/common/Image.astro';

export interface Props {
  popularPosts?: Array<Post>;
  categories?: Array<{ title: string; slug: string; count: number }>;
}

const { popularPosts = [], categories = [] } = Astro.props;
---

<aside class="space-y-8">
  <!-- Search Box -->
  <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6">
    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
      <Icon name="tabler:search" class="w-5 h-5 text-brand-accent" />
      Search Guides
    </h3>
    <form action="/blog" method="get" class="relative">
      <input
        type="search"
        name="q"
        placeholder="Search sleep guides..."
        class="w-full px-4 py-3 pr-12 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-brand-accent focus:border-transparent dark:bg-slate-700 dark:text-white transition"
      />
      <button
        type="submit"
        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-brand-accent hover:text-brand-primary dark:hover:text-brand-accent-light transition"
        aria-label="Search"
      >
        <Icon name="tabler:arrow-right" class="w-5 h-5" />
      </button>
    </form>
  </div>

  <!-- Popular Posts -->
  {popularPosts && popularPosts.length > 0 && (
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6">
      <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
        <Icon name="tabler:flame" class="w-5 h-5 text-brand-accent" />
        Popular Guides
      </h3>
      <ul class="space-y-4">
        {popularPosts.slice(0, 5).map(async (post) => {
          const image = await findImage(post.image);
          const link = getPermalink(post.permalink, 'post');
          return (
            <li>
              <a href={link} class="group flex gap-3 hover:opacity-80 transition">
                {image && (
                  <div class="flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden bg-gray-400 dark:bg-slate-700">
                    <Image
                      src={image}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      widths={[64, 128]}
                      sizes="64px"
                      alt={post.title}
                      aspectRatio="1:1"
                      loading="lazy"
                    />
                  </div>
                )}
                <div class="flex-1 min-w-0">
                  <h4 class="font-medium text-sm line-clamp-2 group-hover:text-brand-accent dark:group-hover:text-brand-accent-light transition">
                    {post.title}
                  </h4>
                  {post.readingTime && (
                    <p class="text-xs text-muted mt-1">
                      {post.readingTime} min read
                    </p>
                  )}
                </div>
              </a>
            </li>
          );
        })}
      </ul>
    </div>
  )}

  <!-- Categories -->
  {categories && categories.length > 0 && (
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6">
      <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
        <Icon name="tabler:folder" class="w-5 h-5 text-brand-accent" />
        Categories
      </h3>
      <ul class="space-y-2">
        {categories.map((category) => (
          <li>
            <a
              href={getPermalink(category.slug, 'category')}
              class="flex items-center justify-between py-2 px-3 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition group"
            >
              <span class="font-medium text-sm group-hover:text-brand-accent dark:group-hover:text-brand-accent-light transition">
                {category.title}
              </span>
              <span class="text-xs text-muted bg-gray-200 dark:bg-slate-600 px-2 py-1 rounded-full">
                {category.count}
              </span>
            </a>
          </li>
        ))}
      </ul>
    </div>
  )}

  <!-- Newsletter CTA -->
  <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-slate-700">
    <div class="flex items-start gap-3 mb-4">
      <Icon name="tabler:mail" class="w-6 h-6 flex-shrink-0 mt-1 text-brand-accent" />
      <div>
        <h3 class="text-lg font-bold mb-2 text-gray-900 dark:text-white">Get Sleep Tips Weekly</h3>
        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
          Join 12,000+ readers getting science-backed sleep optimization strategies.
        </p>
      </div>
    </div>
    <form class="space-y-3">
      <input
        type="email"
        placeholder="Your email"
        class="w-full px-4 py-3 rounded-lg bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 placeholder-gray-400 dark:placeholder-slate-400 text-gray-900 dark:text-white focus:ring-2 focus:ring-brand-accent focus:border-transparent transition focus:outline-none"
        required
      />
      <button
        type="submit"
        class="w-full px-4 py-3 bg-brand-primary text-white rounded-lg font-medium hover:bg-brand-primary/90 disabled:bg-gray-200 disabled:text-gray-600 disabled:cursor-not-allowed dark:disabled:bg-slate-700 dark:disabled:text-slate-300 transition"
      >
        Subscribe
      </button>
    </form>
  </div>
</aside>

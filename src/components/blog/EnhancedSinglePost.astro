---
import { Icon } from 'astro-icon/components';

import Image from '~/components/common/Image.astro';
import PostTags from '~/components/blog/Tags.astro';
import SocialShare from '~/components/common/SocialShare.astro';
import Schema from '~/components/common/Schema.astro';
import TOC from '~/components/blog/TOC.astro';
import AuthorBio from '~/components/blog/AuthorBio.astro';
import AdPlaceholder from '~/components/widgets/AdPlaceholder.astro';

import { getPermalink } from '~/utils/permalinks';
import { getFormattedDate } from '~/utils/utils';

import type { Post } from '~/types';

export interface Props {
  post: Post;
  url: string | URL;
}

const { post, url } = Astro.props;

// Generate Article Schema
const articleSchema = {
  headline: post.title,
  description: post.excerpt || '',
  datePublished: post.publishDate.toISOString(),
  dateModified: (post.updatedDate || post.publishDate).toISOString(),
  author: post.author || 'SleepUpgradeHub',
  image: post.image ? String(url).replace(/\/[^\/]+$/, '') + post.image : undefined,
  url: String(url),
};
---

<!-- Article Schema for SEO -->
<Schema type="article" article={articleSchema} />

<!-- HEALTHLINE-STYLE ARTICLE LAYOUT: Title First, Image Below, Clean Reading Experience -->
<section class="relative bg-white dark:bg-slate-900">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <article class="relative">
      <!-- ABOVE-THE-FOLD: Title, Meta, No Giant Hero -->
      <header class="pt-8 pb-6 border-b border-gray-200 dark:border-slate-800">
        <div class="max-w-4xl mx-auto">
          <!-- Breadcrumb / Category -->
          {post.category && (
            <div class="mb-4">
              <a
                href={getPermalink(post.category.slug, 'category')}
                class="inline-block text-sm font-semibold text-brand-accent uppercase tracking-wide hover:underline"
              >
                {post.category.title}
              </a>
            </div>
          )}

          <!-- Title - Healthline style (immediately readable) -->
          <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold leading-tight mb-4 text-gray-900 dark:text-white">
            {post.title}
          </h1>

          <!-- Subtitle/Excerpt -->
          {post.excerpt && (
            <p class="text-lg md:text-xl text-gray-600 dark:text-gray-400 leading-relaxed mb-6">
              {post.excerpt}
            </p>
          )}

          <!-- Meta Info (Author, Date, Read Time) -->
          <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 dark:text-gray-400">
            {post.author && (
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-brand-accent text-white flex items-center justify-center text-xs font-bold">
                  {post.author.charAt(0).toUpperCase()}
                </div>
                <span class="font-medium">{post.author}</span>
              </div>
            )}
            <span class="text-gray-400">•</span>
            <time datetime={String(post.publishDate)}>{getFormattedDate(post.publishDate)}</time>
            {post.readingTime && (
              <>
                <span class="text-gray-400">•</span>
                <span class="flex items-center gap-1">
                  <Icon name="tabler:clock" class="w-4 h-4" />
                  {post.readingTime} min read
                </span>
              </>
            )}
          </div>
        </div>
      </header>

      <!-- OPTIONAL HERO IMAGE - Small, Below Title (Healthline style) -->
      {post.image && (
        <div class="py-6 border-b border-gray-200 dark:border-slate-800">
          <div class="max-w-4xl mx-auto">
            <div class="rounded-lg overflow-hidden" style="max-height: 500px;">
              <Image
                src={post.image}
                class="w-full h-auto object-cover"
                widths={[400, 768, 1024]}
                sizes="(max-width: 768px) 100vw, 800px"
                alt={post.title}
                loading="eager"
                decoding="async"
              />
            </div>
          </div>
        </div>
      )}

      <!-- MAIN ARTICLE BODY + SIDEBAR -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 py-8">
        <!-- MAIN CONTENT COLUMN (Ideal Reading Width ~700-800px) -->
        <div class="lg:col-span-8 xl:col-span-8">
          <div class="max-w-3xl mx-auto lg:mx-0">
            <!-- Article Content with Healthline-style Typography -->
            <div
              class="prose prose-lg dark:prose-invert max-w-none
                     prose-headings:font-bold prose-headings:tracking-tight prose-headings:text-gray-900 dark:prose-headings:text-white
                     prose-h2:text-2xl prose-h2:mt-10 prose-h2:mb-4 prose-h2:pb-3 prose-h2:border-b prose-h2:border-gray-200 dark:prose-h2:border-slate-700
                     prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-3
                     prose-p:text-gray-700 dark:prose-p:text-gray-300 prose-p:leading-relaxed prose-p:mb-5
                     prose-a:text-brand-accent prose-a:no-underline hover:prose-a:underline prose-a:font-medium
                     prose-strong:text-gray-900 dark:prose-strong:text-white prose-strong:font-semibold
                     prose-ul:my-5 prose-ol:my-5 prose-li:my-1.5 prose-li:text-gray-700 dark:prose-li:text-gray-300
                     prose-blockquote:border-l-4 prose-blockquote:border-brand-accent prose-blockquote:bg-gray-50 dark:prose-blockquote:bg-slate-800
                     prose-blockquote:py-3 prose-blockquote:px-5 prose-blockquote:my-6 prose-blockquote:rounded-r prose-blockquote:not-italic
                     prose-blockquote:text-gray-700 dark:prose-blockquote:text-gray-300
                     prose-code:text-brand-accent prose-code:bg-gray-100 dark:prose-code:bg-slate-800 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm prose-code:font-mono prose-code:before:content-none prose-code:after:content-none
                     prose-pre:bg-gray-900 prose-pre:text-gray-100 prose-pre:rounded-lg prose-pre:shadow-md
                     prose-img:rounded-lg prose-img:shadow-md prose-img:my-6
                     prose-hr:border-gray-200 dark:prose-hr:border-slate-700 prose-hr:my-8
                     prose-table:border-collapse prose-th:bg-gray-50 dark:prose-th:bg-slate-800 prose-th:p-3 prose-td:p-3 prose-td:border prose-td:border-gray-200 dark:prose-td:border-slate-700"
            >
              <slot />
            </div>

            <!-- Tags Section -->
            {post.tags && post.tags.length > 0 && (
              <div class="mt-10 pt-6 border-t border-gray-200 dark:border-slate-700">
                <h3 class="text-base font-bold mb-3 text-gray-900 dark:text-white flex items-center gap-2">
                  <Icon name="tabler:tags" class="w-4 h-4" />
                  Topics Covered
                </h3>
                <PostTags tags={post.tags} />
              </div>
            )}

            <!-- Author Bio Block (Healthline style) -->
            <AuthorBio author={post.author} />
          </div>
        </div>

        <!-- SIDEBAR (Sticky on Desktop) -->
        <div class="lg:col-span-4 xl:col-span-4">
          <div class="lg:sticky lg:top-24 space-y-6">
            <!-- Table of Contents (Healthline style) -->
            <TOC />

            <!-- Share Card -->
            <div class="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 p-6">
              <h3 class="text-base font-bold mb-4 text-gray-900 dark:text-white flex items-center gap-2">
                <Icon name="tabler:share" class="w-4 h-4 text-brand-accent" />
                Share This Guide
              </h3>
              <SocialShare
                url={url}
                text={post.title}
                class="flex flex-col gap-3"
              />
            </div>

            <!-- Ad Placeholder: Sidebar Ad Slot -->
            <AdPlaceholder type="sidebar" label="Sponsored" />

            <!-- Related Topics -->
            {post.tags && post.tags.length > 0 && (
              <div class="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 p-6">
                <h3 class="text-base font-bold mb-4 text-gray-900 dark:text-white flex items-center gap-2">
                  <Icon name="tabler:bookmark" class="w-4 h-4 text-brand-accent" />
                  Related Topics
                </h3>
                <div class="flex flex-wrap gap-2">
                  {post.tags.slice(0, 5).map((tag) => (
                    <a
                      href={getPermalink(tag.slug, 'tag')}
                      class="inline-block px-3 py-1.5 bg-gray-100 dark:bg-slate-700 hover:bg-brand-accent hover:text-white dark:hover:bg-brand-accent rounded-full text-xs font-medium transition"
                    >
                      #{tag.title || tag.slug}
                    </a>
                  ))}
                </div>
              </div>
            )}

            <!-- Compact Email CTA (Sidebar) -->
            <div class="bg-gradient-to-br from-brand-primary to-brand-accent rounded-xl p-6 text-white">
              <Icon name="tabler:mail" class="w-8 h-8 mb-3 opacity-90" />
              <h3 class="text-lg font-bold mb-2">
                Get Sleep Tips Weekly
              </h3>
              <p class="text-blue-100 mb-4 text-sm leading-snug">
                Science-backed strategies delivered to your inbox.
              </p>
              <a
                href="/contact"
                class="inline-block w-full px-4 py-2.5 bg-gray-900 text-white rounded-lg font-semibold text-center text-sm hover:bg-gray-800 transition"
              >
                Subscribe
              </a>
            </div>
          </div>
        </div>
      </div>
    </article>
  </div>
</section>

---
import NewsletterForm from '~/components/common/NewsletterForm.astro';

const { delay = 0 } = Astro.props;
const storageKey = 'newsletter_popup_dismissed';
---

<div
  data-newsletter-popup
  data-popup-delay={delay}
  data-popup-storage={storageKey}
  class="fixed inset-0 z-40 hidden items-center justify-center px-4"
>
  <div data-popup-overlay class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>
  <div class="relative w-full max-w-lg rounded-2xl bg-white/98 dark:bg-slate-900/98 backdrop-blur border border-gray-200 dark:border-slate-700 p-6 drop-shadow-2xl">
    <div class="flex items-start gap-3 mb-3">
      <div class="flex h-10 w-10 items-center justify-center rounded-full bg-green-100 text-green-700 dark:bg-green-900/70 dark:text-green-200">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5">
          <path d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <div class="flex-1">
        <p class="text-sm font-semibold text-gray-900 dark:text-white">Join the Sleep Upgrade list</p>
        <p class="text-xs text-gray-600 dark:text-gray-300">
          Get weekly sleep fixes, monetization-friendly tips, and new guides.
        </p>
      </div>
      <button
        type="button"
        data-newsletter-popup-close
        class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white"
        aria-label="Close newsletter popup"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5">
          <path d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <NewsletterForm
      source="popup"
      layoutClass="space-y-3"
      inputPlaceholder="Enter your email"
      inputClass="px-4 py-3 rounded-lg text-gray-900 dark:text-white bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-brand-accent focus:border-transparent"
      buttonClass="w-full px-4 py-3 bg-brand-primary text-white font-semibold rounded-lg hover:bg-brand-primary/90 transition disabled:bg-gray-200 disabled:text-gray-600 disabled:cursor-not-allowed dark:disabled:bg-slate-700 dark:disabled:text-slate-300"
      buttonText="Get weekly tips"
      redirect="/?subscribed=1"
    />
  </div>
</div>

<script is:inline>
  if (typeof window !== 'undefined') {
    const initPopup = () => {
      const popup = /** @type {HTMLElement | null} */ (
        document.querySelector('[data-newsletter-popup]')
      );
      if (!popup) return;

      const storageKey = popup.dataset.popupStorage || 'newsletter_popup_dismissed';
      const closeButton = popup.querySelector('[data-newsletter-popup-close]');
      const overlay = popup.querySelector('[data-popup-overlay]');

      const openPopup = () => {
        if (localStorage.getItem(storageKey)) return;
        popup.classList.remove('hidden');
        popup.classList.add('flex');
        document.body.classList.add('overflow-hidden');
      };

      const closePopup = () => {
        popup.classList.add('hidden');
        popup.classList.remove('flex');
        document.body.classList.remove('overflow-hidden');
        localStorage.setItem(storageKey, '1');
      };

      if (!localStorage.getItem(storageKey)) {
        const delayMs = Number(popup.dataset.popupDelay || '0');
        if (delayMs > 0) {
          window.setTimeout(openPopup, delayMs);
        } else {
          openPopup();
        }
      }

      closeButton?.addEventListener('click', closePopup);
      overlay?.addEventListener('click', closePopup);
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !popup.classList.contains('hidden')) {
          closePopup();
        }
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPopup, { once: true });
    } else {
      initPopup();
    }
  }
</script>

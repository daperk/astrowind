---
import NewsletterForm from '~/components/common/NewsletterForm.astro';

const { delay = 0 } = Astro.props;
const storageKey = 'newsletter_popup_dismissed';
---

<div
  data-newsletter-popup
  data-popup-delay={delay}
  data-popup-storage={storageKey}
  class="fixed inset-0 z-40 hidden items-center justify-center px-3 py-4"
>
  <div data-popup-overlay class="absolute inset-0 bg-slate-900/80"></div>
  <div class="relative w-full max-w-md md:max-w-lg rounded-xl bg-white border border-gray-200 shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto">
    <!-- Close button -->
    <button
      type="button"
      data-newsletter-popup-close
      class="absolute top-3 right-3 z-10 text-slate-400 hover:text-slate-700 bg-white/80 rounded-full p-1"
      aria-label="Close newsletter popup"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5">
        <path d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <div class="p-5 md:p-6">
      <!-- Header badge -->
      <div class="mb-3 inline-flex items-center gap-2 rounded-full border border-gray-200 bg-gray-50 px-2.5 py-1 text-xs font-semibold text-gray-700">
        <span class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-gray-900 text-white text-[9px] font-bold">SU</span>
        Sleep Upgrade Hub
      </div>

      <!-- Title and description -->
      <h2 class="text-xl md:text-2xl font-bold text-slate-900 leading-tight mb-2">
        Get weekly sleep tips & product picks
      </h2>
      <p class="text-sm text-slate-600 mb-4">
        Join readers improving their rest with actionable tips and curated bedroom upgrades.
      </p>

      <!-- Benefits list - compact -->
      <ul class="space-y-2 text-sm text-slate-700 mb-5">
        <li class="flex items-center gap-2">
          <span class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-emerald-100 text-emerald-700 flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="h-2.5 w-2.5">
              <path d="M5 13l4 4L19 7" />
            </svg>
          </span>
          <span>Evening checklists & habits</span>
        </li>
        <li class="flex items-center gap-2">
          <span class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-emerald-100 text-emerald-700 flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="h-2.5 w-2.5">
              <path d="M5 13l4 4L19 7" />
            </svg>
          </span>
          <span>Science-backed routines</span>
        </li>
        <li class="flex items-center gap-2">
          <span class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-emerald-100 text-emerald-700 flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="h-2.5 w-2.5">
              <path d="M5 13l4 4L19 7" />
            </svg>
          </span>
          <span>Curated product picks</span>
        </li>
      </ul>

      <!-- Newsletter form -->
      <NewsletterForm
        source="popup"
        layoutClass="space-y-3"
        inputPlaceholder="Enter your email"
        inputClass="w-full px-4 py-2.5 rounded-lg text-slate-900 bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent text-sm"
        buttonClass="w-full px-4 py-2.5 bg-gray-900 text-white font-semibold rounded-lg hover:bg-gray-800 transition disabled:bg-gray-200 disabled:text-gray-600 disabled:cursor-not-allowed text-sm"
        buttonText="Subscribe"
        redirect="/?subscribed=1"
      />

      <p class="mt-3 text-xs text-slate-500 text-center">
        No spam. Unsubscribe anytime.
      </p>
    </div>
  </div>
</div>

<script is:inline>
  if (typeof window !== 'undefined') {
    const initPopup = () => {
      const popup = /** @type {HTMLElement | null} */ (
        document.querySelector('[data-newsletter-popup]')
      );
      if (!popup) return;

      const storageKey = popup.dataset.popupStorage || 'newsletter_popup_dismissed';
      const closeButton = popup.querySelector('[data-newsletter-popup-close]');
      const overlay = popup.querySelector('[data-popup-overlay]');

      const openPopup = () => {
        if (localStorage.getItem(storageKey)) return;
        popup.classList.remove('hidden');
        popup.classList.add('flex');
        document.body.classList.add('overflow-hidden');
      };

      const closePopup = () => {
        popup.classList.add('hidden');
        popup.classList.remove('flex');
        document.body.classList.remove('overflow-hidden');
        localStorage.setItem(storageKey, '1');
      };

      if (!localStorage.getItem(storageKey)) {
        const delayMs = Number(popup.dataset.popupDelay || '0');
        if (delayMs > 0) {
          window.setTimeout(openPopup, delayMs);
        } else {
          openPopup();
        }
      }

      closeButton?.addEventListener('click', closePopup);
      overlay?.addEventListener('click', closePopup);
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !popup.classList.contains('hidden')) {
          closePopup();
        }
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPopup, { once: true });
    } else {
      initPopup();
    }
  }
</script>
